<html>
<head>
<title>YATE - External module</title>
</head>
<body>
The work on this document is still in progress.
Please do not use it as reference, the specifications are likely to change.

<h1>External module command flow</h1>

<h2>File handles used</h2>
The external user application or script comunicates with the module trough
several file descriptors:<br />
0 (stdin)    - Carries commands and notifications from engine to application<br />
1 (stdout)   - Carries commands and answers from application to the engine<br />
2 (stderr)   - Has the usual meaning of reporting errors and is directed to the	engine's stderr or logfile<br />
3 (optional) - Transports audio data from the engine to the application<br />
4 (optional) - Transports audio data from the application to the engine<br />

File descriptors 3 and 4 are open only for audio capable applications.<br />


<h2>Format of commands and notifications</h2>

In the following description the _ (underscore) character is used to denote
the TAB character (\t, ^I, decimal 9) used as element separator.<br />

Words enclosed in &lt;angle brackets&gt; must be replaced with the proper value.<br />

Elements in [square brackets] are optional. An ellipsis ... denotes optional
repetition of the last element.<br />

Every command is sent on its own newline (\n, ^J, decimal 10) delimited line.<br />

Any value that contains special characters (ASCII code lower than 32) MUST have
them converted to %&lt;hexcode&gt; where &lt;hexcode&gt; is the 2 character hexadecimal
representation of that ASCII code. The % character itself MUST be converted to
its %25 representation. Characters with codes higher than 32 (except %) SHOULD
not be escaped but may be so. An %-escaped code may be received instead of an
unescaped character anywhere except in the initial keyword or the delimiting
TAB characters. Anywhere in the line except the initial keyword a % character
not followed by 2 hexadecimal digits is an error.<br />

<p><b>Keyword: %%=error</b><br />
%%=error_&lt;original&gt;<br />
The engine sends this notification as answer to a syntactically incorrect line
it received from the application.<br />
&lt;original&gt; - the original line exactly as received (not escaped or something)<br />
</p>

<p><b>Keyword: %%=init</b><br />
%%=init<br />
This command is sent to the other party requesting it to (re)initialize.<br />
</p>

<p><b>Keyword: %%=halt</b><br />
%%=halt[_&lt;exitcode&gt;]<br />
Command from application to the engine asking it to terminate. An optional
exit code may be provided.<br />
&lt;exitcode&gt; - positive numeric engine exit code<br />
</p>

<p><b>Keyword: %%=output</b><br />
%%=output_&lt;message&gt;<br />
Asks the engine to display a message in its console output.<br />
&lt;message&gt; - message line to display as-is<br />
</p>

<p><b>Keyword: %%=debug</b><br />
%%=debug_[&lt;facility&gt;]_&lt;level&gt;_&lt;message&gt;<br />
Asks the engine to emit a debugging message to the console output.<br />
&lt;facility&gt; - optional facility text to display<br />
&lt;level&gt; - numeric debug level (0-9) at which to output<br />
&lt;message&gt; - debug message to display<br />
</p>

<p><b>Keyword: %%&gt;message</b><br />
%%&gt;message_&lt;id&gt;_&lt;name&gt;_&lt;retvalue&gt;[_&lt;key&gt;=&lt;value&gt;...]<br />
This is sent by a party (engine or application) to ask the other to run a
message trough its handlers. The local message must be held until an answer is
received.<br />
&lt;id&gt; - obscure unique message ID string generated by the sender<br />
&lt;name&gt; - name of the message<br />
&lt;retvalue&gt; - default textual return value of the message<br />
&lt;key&gt;=&lt;value&gt; - enumeration of the key-value pairs of the message<br />
</p>

<p><b>Keyword: %%&lt;message</b><br />
%%&lt;message_&lt;id&gt;_&lt;processed&gt;_[&lt;name&gt;]_&lt;retvalue&gt;[_&lt;key&gt;=&lt;value&gt;...]<br />
One of this answer is required for every received message (%%&gt;message). When a
party gets a line in this format it should paste the provided values back into
the message and let it continue.<br />
&lt;id&gt; - same message ID string received trough %%&gt;message<br />
&lt;processed&gt; - boolean (&quot;true&quot; or &quot;false&quot;) indication if the message has been
	processed or it should be passed to the next handler<br />
&lt;name&gt; - new name of the message, if empty keep unchanged<br />
&lt;retvalue&gt; - new textual return value of the message<br />
&lt;key&gt;=&lt;value&gt; - new key-value pairs to set in the message; delete the key if
	the value is an empty string<br />
</p>

<p><b>Keyword: %%&gt;install</b><br />
%%&gt;install_&lt;name&gt;[_&lt;priority&gt;]<br />
Always from the application to the engine, requests the installing of a message
handler<br />
&lt;name&gt; - name of the messages for that a handler should be installed<br />
&lt;priority&gt; - priority, use default if missing<br />
</p>

<p><b>Keyword: %%&lt;install</b><br />
%%&lt;install_&lt;name&gt;_&lt;priority&gt;<br />
Confirmation from engine to the application that the handler has been installed
properly or not.<br />
&lt;name&gt; - name of the messages asked to handle<br />
&lt;priority&gt; - priority of the installed handler, -1 if it failed<br />
</p>

</body>
</html>
