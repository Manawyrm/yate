# Makefile
# This file holds the make rules for the Telephony Engine

# override DEBUG at compile time to enable full debug or remove it all
DEBUG :=

CXX := @CXX@ -Wall
SED := sed
DEFS :=
LIBAUX:= @DLOPEN_LIB@
LIBTHR:= -lpthread
INCLUDES := -I.. -I@top_srcdir@
CFLAGS := -O2 @MODULE_CPPFLAGS@ @INLINE_FLAGS@
LDFLAGS:=
LDCONFIG:=true

MKDEPS := ../config.status
YLIB:= libyate.so.@PACKAGE_VERSION@
CINC := @top_srcdir@/yateclass.h
EINC := $(CINC) @top_srcdir@/yatengine.h
PINC := $(EINC) @top_srcdir@/yatephone.h
CLINC:= $(PINC) @top_srcdir@/yatecbase.h
LIBS :=
CLSOBJS := TelEngine.o ObjList.o HashList.o String.o DataBlock.o NamedList.o \
	URI.o Array.o Iterator.o YMD5.o Mutex.o Thread.o Socket.o
ENGOBJS := Configuration.o Message.o Plugin.o Engine.o
TELOBJS := DataFormat.o Channel.o
CLIOBJS := Client.o

LIBOBJS := $(CLSOBJS) $(ENGOBJS) $(TELOBJS) $(CLIOBJS)
CLEANS = $(LIBOBJS) core
COMPILE = $(CXX) $(DEFS) $(DEBUG) $(INCLUDES) $(CFLAGS)
LINK = $(CXX) $(LDFLAGS)

prefix = @prefix@
exec_prefix = @exec_prefix@

bindir = @bindir@
libdir = @libdir@
incdir = @includedir@/yate
mandir = @mandir@
docdir = $(prefix)/share/doc/yate-@PACKAGE_VERSION@
vardir = @localstatedir@/lib/yate
moddir = @libdir@/yate
confdir = @sysconfdir@/yate

# include optional local make rules
-include YateLocal.mak

.PHONY: all
all: ../$(YLIB)

.PHONY: clean
clean:
	@-$(RM) $(CLEANS) 2>/dev/null

.PHONY: strip
strip: all
	-strip --strip-debug --discard-locals ../$(YLIB)

Engine.o: @srcdir@/Engine.cpp $(MKDEPS) $(EINC) ../yateversn.h ../yatepaths.h
	$(COMPILE) -c $<

Channel.o: @srcdir@/Channel.cpp $(MKDEPS) $(PINC)
	$(COMPILE) -c $<

DataFormat.o: @srcdir@/DataFormat.cpp $(MKDEPS) $(PINC)
	$(COMPILE) -c $<

Socket.o: @srcdir@/Socket.cpp $(MKDEPS) $(CINC)
	$(COMPILE) @FDSIZE_HACK@ -c $<

Mutex.o: @srcdir@/Mutex.cpp $(MKDEPS) $(CINC)
	$(COMPILE) @MUTEX_HACK@ -c $<

Thread.o: @srcdir@/Thread.cpp $(MKDEPS) $(CINC)
	$(COMPILE) @THREAD_KILL@ -c $<

Client.o: @srcdir@/Client.cpp $(MKDEPS) $(CLINC)
	$(COMPILE) -c $<

%.o: @srcdir@/%.cpp $(MKDEPS) $(EINC)
	$(COMPILE) -c $<

Makefile: @srcdir@/Makefile.in $(MKDEPS)
	cd .. && ./config.status

../$(YLIB): $(LIBOBJS) $(LIBS)
	$(LINK) -shared -o $@ -Wl,--soname=$(YLIB) $(LIBTHR) $^ $(LIBAUX)
